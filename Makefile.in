flags=-Ipb -I@protobuf@/include

UNAME_S=$(shell uname -s)

ifeq ($(UNAME_S),Darwin)
	flags += -mmacosx-version-min=10.7 -stdlib=libc++
endif

all : harvest libharvest.a

harvest : harvest.o libharvest.a
	gcc ${flags} -o harvest -lstdc++ -lz -lm harvest.o libharvest.a @protobuf@/lib/libprotobuf.a

libharvest.a : HarvestIO.o pb/harvest.pb.o Tree.o TreeNode.o
	ar -cr libharvest.a HarvestIO.o pb/harvest.pb.o
	ranlib libharvest.a

harvest.o : harvest.cpp HarvestIO.h pb/harvest.pb.h Tree.h TreeNode.h
	gcc ${flags} -c harvest.cpp

HarvestIO.o : HarvestIO.cpp HarvestIO.h pb/harvest.pb.cc pb/harvest.pb.h Tree.h TreeNode.h
	gcc ${flags} -c HarvestIO.cpp

Tree.o : Tree.cpp Tree.h
	gcc ${flags} -c Tree.cpp

TreeNode.o : TreeNode.cpp TreeNode.h
	gcc ${flags} -c TreeNode.cpp

pb/harvest.pb.o : pb/harvest.pb.cc
	@cd pb; gcc ${flags} -c harvest.pb.cc

pb/harvest.pb.cc pb/harvest.pb.h : pb/harvest.proto
	@cd pb; @protobuf@/bin/protoc --cpp_out . harvest.proto

install : libharvest.a
	mkdir -p @prefix@/bin/
	mkdir -p @prefix@/lib/
	mkdir -p @prefix@/include/
	mkdir -p @prefix@/include/Harvest
	ln -sf `pwd`/harvest @prefix@/bin/
	ln -sf `pwd`/libharvest.a @prefix@/lib/
	ln -sf `pwd`/HarvestIO.h @prefix@/include/
	ln -sf `pwd`/pb/harvest.pb.h @prefix@/include/

clean :
	-rm harvest
	-rm libharvest.a
	-rm *.o
	-rm pb/*.o
	-rm pb/*.cc
	-rm pb/*.h
