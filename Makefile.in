flags=-Isrc -I@protobuf@/include -I@flatbuffers@/include

UNAME_S=$(shell uname -s)

ifeq ($(UNAME_S),Darwin)
	flags += -mmacosx-version-min=10.7 -std=c++11 -stdlib=libc++
endif

SOURCES=\
	src/harvest/AnnotationList.cpp \
	src/harvest/harvest.cpp \
	src/harvest/HarvestIO.cpp \
	src/harvest/LcbList.cpp \
	src/harvest/parse.cpp \
	src/harvest/PhylogenyTree.cpp \
	src/harvest/PhylogenyTreeNode.cpp \
	src/harvest/ReferenceList.cpp \
	src/harvest/TrackList.cpp \
	src/harvest/VariantList.cpp \
	
OBJECTS=$(SOURCES:.cpp=.o) src/harvest/pb/harvest.pb.o

all : harvesttools libharvest.a

harvesttools : $(OBJECTS) libharvest.a
	gcc ${flags} -o harvesttools $(OBJECTS) libharvest.a @protobuf@/lib/libprotobuf.a -lstdc++ -lz -lm -lpthread

libharvest.a : $(OBJECTS)
	ar -cr libharvest.a $(OBJECTS)
	ranlib libharvest.a

%.o : %.cpp src/harvest/pb/harvest.pb.h src/harvest/fb/harvest_generated.h
	gcc ${flags} -c $< -o $@

src/harvest/pb/harvest.pb.o : src/harvest/pb/harvest.pb.cc src/harvest/pb/harvest.pb.h
	gcc ${flags} -c src/harvest/pb/harvest.pb.cc -o src/harvest/pb/harvest.pb.o

src/harvest/pb/harvest.pb.cc src/harvest/pb/harvest.pb.h : src/harvest/pb/harvest.proto
	cd src; @protobuf@/bin/protoc --cpp_out . harvest/pb/harvest.proto

src/harvest/fb/harvest_generated.h : src/harvest/fb/harvest.fbs
	cd src/harvest/fb;@flatbuffers@/bin/flatc -c -b harvest.fbs

install : libharvest.a
	mkdir -p @prefix@/bin/
	mkdir -p @prefix@/lib/
	mkdir -p @prefix@/include/
	mkdir -p @prefix@/include/harvest
	mkdir -p @prefix@/include/harvest/pb
	ln -sf `pwd`/harvesttools @prefix@/bin/
	ln -sf `pwd`/libharvest.a @prefix@/lib/
	ln -sf `pwd`/src/harvest/exceptions.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/HarvestIO.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/pb/harvest.pb.h @prefix@/include/harvest/pb/
	ln -sf `pwd`/src/harvest/ReferenceList.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/AnnotationList.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/parse.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/PhylogenyTree.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/PhylogenyTreeNode.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/TrackList.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/LcbList.h @prefix@/include/harvest/
	ln -sf `pwd`/src/harvest/VariantList.h @prefix@/include/harvest/

clean :
	-rm harvesttools
	-rm libharvest.a
	-rm src/harvest/*.o
	-rm src/harvest/pb/*.o
	-rm src/harvest/pb/*.cc
	-rm src/harvest/pb/*.h
