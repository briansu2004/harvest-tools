flags=-Ipb -I@protobuf@/include

all : harvest libharvest.a

harvest : harvest.o libharvest.a
	gcc ${flags} -o harvest -stdlib=libc++ -lc++ -lz harvest.o libharvest.a @protobuf@/lib/libprotobuf.a

libharvest.a : HarvestIO.o pb/harvest.pb.o
	ar -cr libharvest.a HarvestIO.o pb/harvest.pb.o
	ranlib libharvest.a

harvest.o : harvest.cpp HarvestIO.h pb/harvest.pb.h
	gcc ${flags} -c harvest.cpp

HarvestIO.o : HarvestIO.cpp HarvestIO.h pb/harvest.pb.cc pb/harvest.pb.h
	gcc ${flags} -c HarvestIO.cpp

pb/harvest.pb.o : pb/harvest.pb.cc
	@cd pb; gcc ${flags} -c harvest.pb.cc

pb/harvest.pb.cc pb/harvest.pb.h : pb/harvest.proto
	@cd pb; @protobuf@/bin/protoc --cpp_out . harvest.proto

install : libharvest.a
	mkdir -p @prefix@/bin/
	mkdir -p @prefix@/lib/
	mkdir -p @prefix@/include/
	ln -sf `pwd`/harvest @prefix@/bin/
	ln -sf `pwd`/libharvest.a @prefix@/lib/
	ln -sf `pwd`/HarvestIO.h @prefix@/include/
	ln -sf `pwd`/pb/harvest.pb.h @prefix@/include/
